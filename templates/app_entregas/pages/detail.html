{% extends "app_core/partials/base.html" %}
{% block title %}Entrega #{{ entrega.pk }}{% endblock %}
{% block page_title %}Entrega #{{ entrega.pk }}{% endblock %}
{% block breadcrumb %}
  <a href="{% url 'app_core:home' %}">Início</a> ›
  <a href="{% url 'app_entregas:lista' %}">Entregas</a> › Detalhes
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'app_entregas:lista' %}">Voltar</a>
  <button class="btn btn-outline-primary btn-sm" onclick="window.print()">Imprimir</button>
  {% if perms.app_entregas.change_entrega and entrega.status in "EMPRESTADO,EM_USO" %}
    <form method="post" action="{% url 'app_entregas:marcar_devolvido' entrega.pk %}">
      {% csrf_token %}
      <button class="btn btn-outline-success btn-sm" onclick="return confirm('Confirmar devolução?')">Devolver</button>
    </form>
    <form method="post" action="{% url 'app_entregas:marcar_perdido' entrega.pk %}">
      {% csrf_token %}
      <button class="btn btn-outline-danger btn-sm" onclick="return confirm('Marcar como PERDIDO?')">Perdido</button>
    </form>
  {% endif %}
  {% if perms.app_entregas.change_entrega %}
    <a class="btn btn-outline-primary btn-sm" href="{% url 'app_entregas:editar' entrega.pk %}">Editar</a>
  {% endif %}
  {% if perms.app_entregas.delete_entrega %}
    <a class="btn btn-outline-danger btn-sm" href="{% url 'app_entregas:excluir' entrega.pk %}">Excluir</a>
  {% endif %}
</div>

<div class="row g-3">
  <div class="col-12 col-xl-8">
    <div class="card">
      <div class="card-header"><h2 class="m-0 fs-6">Resumo da Entrega</h2></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4 col-lg-3">Data da entrega</dt>
          <dd class="col-sm-8 col-lg-9">{{ entrega.data_entrega|date:"d/m/Y H:i" }}</dd>

          <dt class="col-sm-4 col-lg-3">Prevista de devolução</dt>
          <dd class="col-sm-8 col-lg-9">
            {% if entrega.data_prevista_devolucao %}{{ entrega.data_prevista_devolucao|date:"d/m/Y H:i" }}{% else %}-{% endif %}
          </dd>

          <dt class="col-sm-4 col-lg-3">Data da devolução</dt>
          <dd class="col-sm-8 col-lg-9">
            {% if entrega.data_devolucao %}{{ entrega.data_devolucao|date:"d/m/Y H:i" }}{% else %}-{% endif %}
          </dd>

          <dt class="col-sm-4 col-lg-3">Colaborador</dt>
          <dd class="col-sm-8 col-lg-9">{{ entrega.colaborador.nome }}</dd>

          <dt class="col-sm-4 col-lg-3">EPI</dt>
          <dd class="col-sm-8 col-lg-9">
            {{ entrega.epi.nome }}
            {% if entrega.epi.codigo %}<span class="text-muted">({{ entrega.epi.codigo }})</span>{% endif %}
            {% if entrega.epi.categoria %}<div class="small text-muted">Categoria: {{ entrega.epi.categoria.nome }}</div>{% endif %}
          </dd>

          <dt class="col-sm-4 col-lg-3">Quantidade</dt>
          <dd class="col-sm-8 col-lg-9">{{ entrega.quantidade }}</dd>

          <dt class="col-sm-4 col-lg-3">Status</dt>
          <dd class="col-sm-8 col-lg-9">
            {% if entrega.status == "EMPRESTADO" %}
              <span class="badge bg-warning text-dark">Emprestado</span>
            {% elif entrega.status == "EM_USO" %}
              <span class="badge bg-info text-dark">Em uso</span>
            {% elif entrega.status == "FORNECIDO" %}
              <span class="badge bg-primary">Fornecido</span>
            {% elif entrega.status == "DEVOLVIDO" %}
              <span class="badge bg-success">Devolvido</span>
            {% elif entrega.status == "DANIFICADO" %}
              <span class="badge bg-danger">Danificado</span>
            {% elif entrega.status == "PERDIDO" %}
              <span class="badge bg-secondary">Perdido</span>
            {% else %}
              <span class="badge bg-light text-dark">{{ entrega.get_status_display }}</span>
            {% endif %}
          </dd>

          {% if entrega.observacao %}
            <dt class="col-sm-4 col-lg-3">Observação</dt>
            <dd class="col-sm-8 col-lg-9">{{ entrega.observacao }}</dd>
          {% endif %}

          {% if entrega.observacao_devolucao %}
            <dt class="col-sm-4 col-lg-3">Obs. devolução</dt>
            <dd class="col-sm-8 col-lg-9">{{ entrega.observacao_devolucao }}</dd>
          {% endif %}

          <dt class="col-sm-4 col-lg-3">Criado em</dt>
          <dd class="col-sm-8 col-lg-9">{{ entrega.created_at|date:"d/m/Y H:i" }}</dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-4">
    <div class="card">
      <div class="card-header"><h2 class="m-0 fs-6">Solicitação</h2></div>
      <div class="card-body">
        {% if entrega.solicitacao %}
          <dl class="row mb-0">
            <dt class="col-sm-5"># Solicitação</dt>
            <dd class="col-sm-7">{{ entrega.solicitacao.pk }}</dd>

            <dt class="col-sm-5">Criada em</dt>
            <dd class="col-sm-7">{{ entrega.solicitacao.criado_em|date:"d/m/Y H:i" }}</dd>

            <dt class="col-sm-5">Status</dt>
            <dd class="col-sm-7">{{ entrega.solicitacao.get_status_display }}</dd>

            <dt class="col-sm-5">Qtd solicitada</dt>
            <dd class="col-sm-7">{{ entrega.solicitacao.quantidade }}</dd>

            {% if entrega.solicitacao.observacao %}
              <dt class="col-sm-5">Observação</dt>
              <dd class="col-sm-7">{{ entrega.solicitacao.observacao }}</dd>
            {% endif %}
          </dl>
        {% else %}
          <p class="mb-0 text-muted">Sem solicitação vinculada (registro legado).</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
