{% extends "app_core/base.html" %}
{% block title %}Entregas{% endblock %}
{% block page_title %}Entregas{% endblock %}
{% block breadcrumb %}<a href="{% url 'app_core:home' %}">Início</a> › Entregas{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h2 class="m-0 fs-5">Histórico de Entregas</h2>
    {% if perms.app_entregas.add_entrega %}
      <a class="btn btn-outline-primary btn-sm" href="{% url 'app_entregas:criar' %}">Nova Entrega</a>
    {% endif %}
  </div>

  <div class="card-body">
    <form method="get" class="row g-2 align-items-end mb-3">
      <div class="col-12 col-lg-4">
        <label class="form-label">Buscar</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Colaborador, e-mail, matrícula, EPI ou código">
      </div>
      <div class="col-6 col-lg-3">
        <label class="form-label">Colaborador</label>
        <select name="colaborador" class="form-select">
          <option value="">Todos</option>
          {% for c in colaboradores %}
            <option value="{{ c.id }}" {% if colaborador_id|default:'' == c.id|stringformat:'s' %}selected{% endif %}>{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-lg-3">
        <label class="form-label">EPI</label>
        <select name="epi" class="form-select">
          <option value="">Todos</option>
          {% for e in epis %}
            <option value="{{ e.id }}" {% if epi_id|default:'' == e.id|stringformat:'s' %}selected{% endif %}>{{ e.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">Todos</option>
          {% for val,label in statuses %}
            <option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-lg-auto">
        <button class="btn btn-primary" type="submit">Filtrar</button>
        <a class="btn btn-outline-secondary" href="{% url 'app_entregas:lista' %}">Limpar</a>
      </div>
    </form>

    {% if entregas %}
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead>
            <tr>
              <th>Data</th>
              <th>Prevista</th>
              <th>Devolução</th>
              <th>Colaborador</th>
              <th>EPI</th>
              <th class="text-center">Qtd</th>
              <th>Status</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entregas %}
              <tr>
                <td>{{ e.data_entrega|date:"d/m/Y H:i" }}</td>
                <td>{% if e.data_prevista_devolucao %}{{ e.data_prevista_devolucao|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
                <td>{% if e.data_devolucao %}{{ e.data_devolucao|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
                <td>{{ e.colaborador.nome }}</td>
                <td>
                  {{ e.epi.nome }}
                  {% if e.epi.codigo %}<span class="text-muted small">({{ e.epi.codigo }})</span>{% endif %}
                </td>
                <td class="text-center">{{ e.quantidade }}</td>
                <td>
                  {% if e.status == "EMPRESTADO" %}
                    <span class="badge bg-warning text-dark">Emprestado</span>
                  {% elif e.status == "EM_USO" %}
                    <span class="badge bg-info text-dark">Em uso</span>
                  {% elif e.status == "FORNECIDO" %}
                    <span class="badge bg-primary">Fornecido</span>
                  {% elif e.status == "DEVOLVIDO" %}
                    <span class="badge bg-success">Devolvido</span>
                  {% elif e.status == "DANIFICADO" %}
                    <span class="badge bg-danger">Danificado</span>
                  {% elif e.status == "PERDIDO" %}
                    <span class="badge bg-secondary">Perdido</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ e.get_status_display }}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="d-inline-flex flex-wrap gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'app_entregas:detalhe' e.pk %}">Detalhes</a>

                    {% if perms.app_entregas.change_entrega %}
                      {% if e.status == "EMPRESTADO" or e.status == "EM_USO" %}
                        <form method="post" action="{% url 'app_entregas:marcar_devolvido' e.pk %}">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-success" onclick="return confirm('Confirmar devolução?')">Devolver</button>
                        </form>
                        <form method="post" action="{% url 'app_entregas:marcar_perdido' e.pk %}">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Marcar como PERDIDO?')">Perdido</button>
                        </form>
                      {% endif %}
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'app_entregas:editar' e.pk %}">Editar</a>
                    {% endif %}

                    {% if perms.app_entregas.delete_entrega %}
                      <a class="btn btn-sm btn-outline-danger" href="{% url 'app_entregas:excluir' e.pk %}">Excluir</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if is_paginated %}
        <nav class="mt-2">
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.previous_page_number }}">«</a>
              </li>
            {% endif %}
            <li class="page-item disabled">
              <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.next_page_number }}">»</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <p class="mb-0">Nenhuma entrega para os filtros aplicados.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
