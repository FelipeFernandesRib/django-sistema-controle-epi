{% extends "app_core/partials/base.html" %}
{% block title %}Relatórios — Entregas{% endblock %}
{% block page_title %}Relatórios de Entregas{% endblock %}
{% block breadcrumb %}<a href="{% url 'app_core:home' %}">Início</a> › Relatórios{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h2>Filtros</h2>
  </div>
  <div class="card-body">
    <form method="get" class="search-form" style="display:grid; gap:12px; grid-template-columns: repeat(6, 1fr); align-items:end;">
      <div>
        <label>De</label>
        {{ form.data_de }}
      </div>
      <div>
        <label>Até</label>
        {{ form.data_ate }}
      </div>
      <div style="grid-column: span 2;">
        <label>Colaborador</label>
        {{ form.colaborador }}
      </div>
      <div style="grid-column: span 2;">
        <label>EPI</label>
        {{ form.epi }}
      </div>
      <div>
        <label>Status</label>
        {{ form.status }}
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" type="submit">Aplicar</button>
        <a class="btn outline" href="{% url 'app_relatorios:index' %}">Limpar</a>
        <a class="btn" href="{% url 'app_relatorios:exportar' %}?{{ request.GET.urlencode }}">Exportar CSV</a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header"><h2>Resumo</h2></div>
  <div class="card-body">
    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
      <div class="stat"><strong>Registros</strong><div>{{ agg.registros|default:0 }}</div></div>
      <div class="stat"><strong>Qtd total</strong><div>{{ agg.quantidade_total|default:0 }}</div></div>
      <div class="stat"><strong>Entregues (ativos)</strong><div>{{ agg.total_entregue|default:0 }}</div></div>
      <div class="stat"><strong>Devolvidos</strong><div>{{ agg.total_devolvido|default:0 }}</div></div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header"><h2>Movimentações</h2></div>
  <div class="card-body">
    {% if qs %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr><th>Data</th><th>Colaborador</th><th>EPI</th><th>Qtd</th><th>Status</th><th>Obs.</th></tr>
          </thead>
          <tbody>
          {% for e in qs %}
            <tr>
              <td>{{ e.data_entrega|date:"d/m/Y H:i" }}</td>
              <td>{{ e.colaborador.nome }}</td>
              <td>{{ e.epi.nome }} ({{ e.epi.codigo }})</td>
              <td>{{ e.quantidade }}</td>
              <td>{{ e.get_status_display }}</td>
              <td>{{ e.observacao }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Nenhum resultado para os filtros aplicados.</p>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header"><h2>Resumo por EPI</h2></div>
  <div class="card-body">
    {% if por_epi %}
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>EPI</th><th>Entregues</th><th>Devolvidos</th><th>Cancelados</th></tr></thead>
          <tbody>
            {% for r in por_epi %}
              <tr>
                <td>{{ r.epi__nome }} ({{ r.epi__codigo }})</td>
                <td>{{ r.entregues|default:0 }}</td>
                <td>{{ r.devolvidos|default:0 }}</td>
                <td>{{ r.cancelados|default:0 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Sem dados.</p>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header"><h2>Resumo por Colaborador</h2></div>
  <div class="card-body">
    {% if por_colab %}
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>Colaborador</th><th>Entregues</th><th>Devolvidos</th><th>Cancelados</th></tr></thead>
          <tbody>
            {% for r in por_colab %}
              <tr>
                <td>{{ r.colaborador__nome }}</td>
                <td>{{ r.entregues|default:0 }}</td>
                <td>{{ r.devolvidos|default:0 }}</td>
                <td>{{ r.cancelados|default:0 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Sem dados.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
