{% extends "app_core/partials/base.html" %}
{% load static %}

{% block title %}Lista de Entregas{% endblock %}
{% block page_title %}Entregas{% endblock %}
{% block breadcrumb %}<a href="{% url 'app_core:home' %}">Início</a> › Entregas{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'app_entregas/css/main.css' %}?v=l1">
{% endblock %}

  {% block content %}
<div class="card">
  <div class="card-header">
    <h2>Lista de Entregas</h2>
    <form method="get" class="search-form" style="display:flex; gap:8px; flex-wrap: wrap; align-items:center;">
      <input type="text" name="q" value="{{ q }}" placeholder="Buscar por colaborador, e-mail, matrícula, EPI ou código" />
      <select name="colaborador">
        <option value="">-- Colaborador --</option>
        {% for c in colaboradores %}
          <option value="{{ c.id }}" {% if colaborador_id|default:'' == c.id|stringformat:'s' %}selected{% endif %}>{{ c.nome }}</option>
        {% endfor %}
      </select>
      <select name="epi">
        <option value="">-- EPI --</option>
        {% for e in epis %}
          <option value="{{ e.id }}" {% if epi_id|default:'' == e.id|stringformat:'s' %}selected{% endif %}>{{ e.nome }}</option>
        {% endfor %}
      </select>
      <select name="status">
        <option value="">-- Status --</option>
        {% for value,label in statuses %}
          <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn" type="submit">Filtrar</button>
      {% if perms.app_entregas.add_entrega %}
        <a class="btn outline" href="{% url 'app_entregas:criar' %}">Nova Entrega</a>
      {% endif %}
    </form>
  </div>

  <div class="card-body">
    {% if entregas %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Colaborador</th>
            <th>EPI</th>
            <th>Qtd</th>
            <th>Status</th>
            <th class="actions">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entregas %}
          <tr>
            <td>{{ e.data_entrega|date:"d/m/Y H:i" }}</td>
            <td>{{ e.colaborador.nome }}</td>
            <td>{{ e.epi.nome }}</td>
            <td>{{ e.quantidade }}</td>
            <td>
              {% if e.status == 'ENTREGUE' %}<span class="badge success">Entregue</span>
              {% elif e.status == 'DEVOLVIDO' %}<span class="badge">Devolvido</span>
              {% else %}<span class="badge">Cancelado</span>{% endif %}
            </td>
            <td class="actions">
              <a class="btn small" href="{% url 'app_entregas:detalhe' e.pk %}">Detalhes</a>
              {% if perms.app_entregas.change_entrega %}
                <a class="btn small" href="{% url 'app_entregas:editar' e.pk %}">Editar</a>
              {% endif %}
              {% if perms.app_entregas.delete_entrega %}
                <a class="btn small danger" href="{% url 'app_entregas:excluir' e.pk %}">Excluir</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?q={{ q }}&colaborador={{ colaborador_id }}&epi={{ epi_id }}&status={{ status }}&page={{ page_obj.previous_page_number }}">« Anterior</a>
      {% endif %}
      <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?q={{ q }}&colaborador={{ colaborador_id }}&epi={{ epi_id }}&status={{ status }}&page={{ page_obj.next_page_number }}">Próxima »</a>
      {% endif %}
    </div>
    {% endif %}

    {% else %}
      <p>Nenhuma entrega encontrada.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'app_entregas/js/main.js' %}"></script>
{% endblock %}
